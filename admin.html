<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin | Approve Deposits</title>

<style>
body {
  background:#020617;
  color:#fff;
  font-family:Arial;
  padding:30px;
}
.card {
  background:#0b1220;
  padding:15px;
  border-radius:10px;
  margin-bottom:12px;
}
button {
  background:#22c55e;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>Pending Deposits</h2>
<div id="deposits"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const supabase = supabasejs.createClient(
  "https://lghhofyhzopfnibodsjw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnaGhvZnloem9wZm5pYm9kc2p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTAzODEsImV4cCI6MjA4MTU2NjM4MX0.oTxQ7U5HcP9OO7rAuMN7awk1EQQn_TuDrL-AZ-uK-5w"
);

async function loadDeposits() {
  const { data } = await supabase
    .from("deposits")
    .select("*")
    .eq("status", "pending");

  let html = "";
  data.forEach(d => {
    html += `
      <div class="card">
        <b>User:</b> ${d.user_id}<br>
        <b>Amount:</b> $${d.amount}<br>
        <b>Method:</b> ${d.method}<br>
        <b>TXID:</b> ${d.txid}<br><br>
        <button onclick="approve('${d.id}', '${d.user_id}', ${d.amount})">
          Approve
        </button>
      </div>
    `;
  });

  document.getElementById("deposits").innerHTML = html;
}

async function approve(depositId, userId, amount) {

  // 1. Mark deposit approved
  await supabase
    .from("deposits")
    .update({ status: "approved" })
    .eq("id", depositId);

  // 2. Add balance
  const { data: wallet } = await supabase
    .from("wallets")
    .select("balance")
    .eq("user_id", userId)
    .single();

  await supabase
    .from("wallets")
    .update({ balance: wallet.balance + amount })
    .eq("user_id", userId);

  // 3. Add transaction history
  await supabase.from("transactions").insert({
    user_id: userId,
    amount: amount,
    description: "Deposit approved by admin"
  });

  alert("Deposit approved & balance updated");
  loadDeposits();
}

loadDeposits();
</script>

</body>
</html>
